From: Michael Niedermayer <michaelni@gmx.at>
Date: Mon, 29 Jun 2015 19:08:05 +0000 (+0200)
Subject: avcodec/pngdec: Only allow one IHDR chunk
X-Git-Tag: n2.8~1342
X-Git-Url: http://git.videolan.org/?p=ffmpeg.git;a=commitdiff_plain;h=47f4e2d8960ca756ca153ab8e3e93d80449b8c91

avcodec/pngdec: Only allow one IHDR chunk

Multiple IHDR chunks are forbidden in PNG
Fixes inconsistency and out of array accesses

Fixes: asan_heap-oob_4d5c5a_1738_cov_2638287726_c-m2-8f2b481b7fd9bd745e620b7c01a18df2.png

Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
---

--- a/libavcodec/pngdec.c
+++ b/libavcodec/pngdec.c
@@ -451,6 +451,11 @@
                 goto fail;
             }
 
+            if (s->state & PNG_IHDR) {
+                av_log(avctx, AV_LOG_ERROR, "Multiple IHDR\n");
+                goto fail;
+            }
+
             s->width  = bytestream2_get_be32(&s->gb);
             s->height = bytestream2_get_be32(&s->gb);
             if (av_image_check_size(s->width, s->height, 0, avctx)) {
