From 76f7e70aa04fc5dbef5242b11cbf8fe4499f61d4 Mon Sep 17 00:00:00 2001
From: Anton Khirnov <anton@khirnov.net>
Date: Wed, 20 Jul 2016 08:31:38 +0200
Subject: [PATCH] h264dec: handle zero-sized NAL units in get_last_needed_nal()

The current code will ignore the init_get_bits() failure and do an
invalid read from the uninitialized GetBitContext.

Found-By: Jan Ruge <jan.s.ruge@gmail.com>
Bug-Id: 952
---
 libavcodec/h264.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

--- a/libavcodec/h264.c
+++ b/libavcodec/h264.c
@@ -1364,6 +1364,7 @@
     int nal_index   = 0;
     int buf_index   = 0;
     int nals_needed = 0;
+    int ret         = 0;
 
     while(1) {
         int nalsize = 0;
@@ -1405,7 +1406,14 @@
         case NAL_DPA:
         case NAL_IDR_SLICE:
         case NAL_SLICE:
-            init_get_bits(&h->gb, ptr, bit_length);
+            ret = init_get_bits8(&h->gb, ptr, bit_length);
+            if (ret < 0) {
+                av_log(h->avctx, AV_LOG_ERROR, "Invalid zero-sized VCL NAL unit\n");
+                if (h->avctx->err_recognition & AV_EF_EXPLODE)
+                    return ret;
+
+                break;
+            }
             if (!get_ue_golomb(&h->gb))
                 nals_needed = nal_index;
         }
