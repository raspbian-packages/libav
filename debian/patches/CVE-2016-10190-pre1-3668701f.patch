From 3668701f96005f4f7fc3145c800911e39351c132 Mon Sep 17 00:00:00 2001
From: Michael Niedermayer <michaelni@gmx.at>
Date: Sun, 29 Mar 2015 00:33:35 +0100
Subject: [PATCH] avformat/http: Return an error in case of prematurely ending
 data

Fixes Ticket 4039

Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
---
 libavformat/http.c | 8 ++++++++
 1 file changed, 8 insertions(+)

--- a/libavformat/http.c
+++ b/libavformat/http.c
@@ -707,6 +707,14 @@
             s->filesize >= 0 && s->off >= s->filesize)
             return AVERROR_EOF;
         len = ffurl_read(s->hd, buf, size);
+        if (!len && (!s->willclose || s->chunksize < 0) &&
+            s->filesize >= 0 && s->off < s->filesize) {
+            av_log(h, AV_LOG_ERROR,
+                   "Streams ends prematurly at %"PRId64", should be %"PRId64"\n",
+                   s->off, s->filesize
+                  );
+            return AVERROR(EIO);
+        }
     }
     if (len > 0) {
         s->off += len;
