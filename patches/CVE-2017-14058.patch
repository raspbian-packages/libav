From 7ec414892ddcad88313848494b6fc5f437c9ca4a Mon Sep 17 00:00:00 2001
From: Michael Niedermayer <michael@niedermayer.cc>
Date: Sat, 26 Aug 2017 01:26:58 +0200
Subject: [PATCH] avformat/hls: Fix DoS due to infinite loop

Fixes: loop.m3u

The default max iteration count of 1000 is arbitrary and ideas for a better solution are welcome

Found-by: Xiaohei and Wangchu from Alibaba Security Team

Previous version reviewed-by: Steven Liu <lingjiujianke@gmail.com>
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>

[sunweaver] Rebased against a libavformat/hls.c version that did not yet have AVOption support.
            Initializing HLS_Context.max_reload statically with the value 1000.

---
 doc/demuxers.texi | 18 ++++++++++++++++++
 libavformat/hls.c |  7 +++++++
 2 files changed, 25 insertions(+)

#--- a/doc/demuxers.texi
#+++ b/doc/demuxers.texi
#@@ -18,6 +18,24 @@
# 
# The description of some of the currently available demuxers follows.
# 
#+@section hls
#+
#+HLS demuxer
#+
#+It accepts the following options:
#+
#+@table @option
#+@item live_start_index
#+segment index to start live streams at (negative values are from the end).
#+
#+@item allowed_extensions
#+',' separated list of file extensions that hls is allowed to access.
#+
#+@item max_reload
#+Maximum number of times a insufficient list is attempted to be reloaded.
#+Default value is 1000.
#+@end table
#+
# @section image2
# 
# Image file demuxer.
--- a/libavformat/hls.c
+++ b/libavformat/hls.c
@@ -381,6 +381,7 @@
     struct variant *v = opaque;
     HLSContext *c = v->parent->priv_data;
     int ret, i;
+    int reload_count = 0;
 
 restart:
     if (!v->input) {
@@ -391,6 +392,9 @@
                                   v->target_duration;
 
 reload:
+        reload_count++;
+        if (reload_count > 1000)
+            return AVERROR_EOF;
         if (!v->finished &&
             av_gettime() - v->last_load_time >= reload_interval) {
             if ((ret = parse_playlist(c, v->url, v, NULL)) < 0)
