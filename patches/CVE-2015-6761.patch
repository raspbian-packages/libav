From: Michael Niedermayer <michael@niedermayer.cc>
Date: Wed, 30 Sep 2015 11:10:48 +0000 (+0200)
Subject: avcodec/vp8: Do not use num_coeff_partitions in thread/buffer setup
X-Git-Tag: n3.0~2422
X-Git-Url: http://git.videolan.org/?p=ffmpeg.git;a=commitdiff_plain;h=dabea74d0e82ea80cd344f630497cafcb3ef872c

avcodec/vp8: Do not use num_coeff_partitions in thread/buffer setup

The variable is not a constant and can lead to race conditions

Fixes: repro.webm (not reproducable with FFmpeg alone)

Found-by: Dale Curtis <dalecurtis@google.com>
Tested-by: Dale Curtis <dalecurtis@google.com>
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
---

--- a/libavcodec/vp8.c
+++ b/libavcodec/vp8.c
@@ -156,7 +156,7 @@
     s->mb_height = (s->avctx->coded_height + 15) / 16;
 
     s->mb_layout = is_vp7 || avctx->active_thread_type == FF_THREAD_SLICE &&
-                   FFMIN(s->num_coeff_partitions, avctx->thread_count) > 1;
+                   avctx->thread_count > 1;
     if (!s->mb_layout) { // Frame threading and one thread
         s->macroblocks_base       = av_mallocz((s->mb_width + s->mb_height * 2 + 1) *
                                                sizeof(*s->macroblocks));
