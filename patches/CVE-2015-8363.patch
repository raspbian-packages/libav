
m: Michael Niedermayer <michael@niedermayer.cc>
Date: Fri, 13 Nov 2015 23:51:56 +0000 (+0100)
Subject: avcodec/jpeg2000dec: Check for duplicate SIZ marker
X-Git-Tag: n3.0~1580
X-Git-Url: http://git.videolan.org/?p=ffmpeg.git;a=commitdiff_plain;h=44a7f17d0b20e6f8d836b2957e3e357b639f19a2

avcodec/jpeg2000dec: Check for duplicate SIZ marker

Fixes: 0231a17345734228011c6f35a64e4594/asan_heap-oob_1d92a72_3218_1213809a9e3affec77e4c191fdfdc0a9.mov

Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
---

--- a/libavcodec/jpeg2000dec.c
+++ b/libavcodec/jpeg2000dec.c
@@ -1265,6 +1265,7 @@
     }
     av_freep(&s->tile);
     s->numXtiles = s->numYtiles = 0;
+    s->ncomponents = 0;
 }
 
 static int jpeg2000_read_main_headers(Jpeg2000DecoderContext *s)
@@ -1315,6 +1316,10 @@
 
         switch (marker) {
         case JPEG2000_SIZ:
+            if (s->ncomponents) {
+                av_log(s->avctx, AV_LOG_ERROR, "Duplicate SIZ\n");
+                return AVERROR_INVALIDDATA;
+            }
             ret = get_siz(s);
             break;
         case JPEG2000_COC:
