From 3f621455d62e46745453568d915badd5b1e5bcd5 Mon Sep 17 00:00:00 2001
From: Michael Niedermayer <michael@niedermayer.cc>
Date: Sun, 28 Jan 2018 02:46:56 +0100
Subject: [PATCH] avfilter/vf_transpose: Fix regression with packed pixel
 formats

Regression since: c6939f65a116b1ffed345d29d8621ee4ffb32235
Found-by: Paul B Mahol <onemda@gmail.com>
Reviewed-by: Paul B Mahol <onemda@gmail.com>
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
---
 libavfilter/vf_transpose.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/libavfilter/vf_transpose.c
+++ b/libavfilter/vf_transpose.c
@@ -27,6 +27,7 @@
 
 #include <stdio.h>
 
+#include "libavutil/avassert.h"
 #include "libavutil/imgutils.h"
 #include "libavutil/internal.h"
 #include "libavutil/intreadwrite.h"
@@ -48,6 +49,7 @@
 typedef struct TransContext {
     const AVClass *class;
     int hsub, vsub;
+    int planes;
     int pixsteps[4];
 
     enum TransposeDir dir;
@@ -93,6 +95,9 @@
 
     trans->hsub = desc_in->log2_chroma_w;
     trans->vsub = desc_in->log2_chroma_h;
+    trans->planes = desc_in->nb_components;
+
+    av_assert0(desc_in->nb_components == desc_out->nb_components);
 
     av_image_fill_max_pixsteps(trans->pixsteps, NULL, desc_out);
 
@@ -135,7 +140,7 @@
         out->sample_aspect_ratio.den = in->sample_aspect_ratio.num;
     }
 
-    for (plane = 0; out->data[plane]; plane++) {
+    for (plane = 0; plane < trans->planes; plane++) {
         int hsub    = plane == 1 || plane == 2 ? trans->hsub : 0;
         int vsub    = plane == 1 || plane == 2 ? trans->vsub : 0;
         int pixstep = trans->pixsteps[plane];
