From: Michael Niedermayer <michaelni@gmx.at>
Date: Wed, 26 Nov 2014 14:45:47 +0000 (+0100)
Subject: avcodec/pngdec: Check IHDR/IDAT order
X-Git-Tag: n2.5~151
X-Git-Url: http://git.videolan.org/?p=ffmpeg.git;a=commitdiff_plain;h=79ceaf827be0b070675d4cd0a55c3386542defd8

avcodec/pngdec: Check IHDR/IDAT order

Fixes out of array access
Fixes: asan_heap-oob_20a6c26_2690_cov_3434532168_mail.png
Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
Signed-off-by: Michael Niedermayer <michaelni@gmx.at>

[sunweaver] - Port this commit to libav in Debian jessie.
---

--- a/libavcodec/pngdec.c
+++ b/libavcodec/pngdec.c
@@ -445,6 +445,12 @@
         case MKTAG('I', 'H', 'D', 'R'):
             if (length != 13)
                 goto fail;
+
+            if (s->state & PNG_IDAT) {
+                av_log(avctx, AV_LOG_ERROR, "IHDR after IDAT\n");
+                goto fail;
+            }
+
             s->width  = bytestream2_get_be32(&s->gb);
             s->height = bytestream2_get_be32(&s->gb);
             if (av_image_check_size(s->width, s->height, 0, avctx)) {
