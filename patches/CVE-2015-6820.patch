From: Michael Niedermayer <michaelni@gmx.at>
Date: Wed, 1 Jul 2015 00:05:43 +0000 (+0200)
Subject: avcodec/aacsbr: check that the element type matches before applying SBR
X-Git-Tag: n2.8~1308
X-Git-Url: http://git.videolan.org/?p=ffmpeg.git;a=commitdiff_plain;h=79a98294da6cd85f8c86b34764c5e0c43b09eea3

avcodec/aacsbr: check that the element type matches before applying SBR

Fixes out of array access
Fixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux

Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
Signed-off-by: Michael Niedermayer <michaelni@gmx.at>
---

--- a/libavcodec/aacsbr.c
+++ b/libavcodec/aacsbr.c
@@ -1006,6 +1006,8 @@
 {
     unsigned int cnt = get_bits_count(gb);
 
+    sbr->id_aac = id_aac;
+
     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {
         if (read_sbr_single_channel_element(ac, sbr, gb)) {
             sbr_turnoff(sbr);
@@ -1658,6 +1660,12 @@
     int nch = (id_aac == TYPE_CPE) ? 2 : 1;
     int err;
 
+    if (id_aac != sbr->id_aac) {
+        av_log(ac->avctx, AV_LOG_ERROR,
+            "element type mismatch %d != %d\n", id_aac, sbr->id_aac);
+        sbr_turnoff(sbr);
+    }
+
     if (!sbr->kx_and_m_pushed) {
         sbr->kx[0] = sbr->kx[1];
         sbr->m[0] = sbr->m[1];
--- a/libavcodec/sbr.h
+++ b/libavcodec/sbr.h
@@ -114,6 +114,7 @@
 typedef struct SpectralBandReplication {
     int                sample_rate;
     int                start;
+    int                id_aac;
     int                reset;
     SpectrumParameters spectrum_params;
     int                bs_amp_res_header;
