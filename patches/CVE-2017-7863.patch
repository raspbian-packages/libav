From e477f09d0b3619f3d29173b2cd593e17e2d1978e Mon Sep 17 00:00:00 2001
From: Michael Niedermayer <michael@niedermayer.cc>
Date: Sat, 4 Feb 2017 12:24:14 +0100
Subject: [PATCH] avcodec/pngdec: Check trns more completely

Fixes out of array access
Fixes: 546/clusterfuzz-testcase-4809433909559296

Found-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>

[sunweaver] ported to libav in Debian jessie LTS (which only supports palette based transparency).

---
 libavcodec/pngdec.c | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

--- a/libavcodec/pngdec.c
+++ b/libavcodec/pngdec.c
@@ -592,6 +592,16 @@
         {
             int v, i;
 
+            if (!(s->state & PNG_IHDR)) {
+                av_log(avctx, AV_LOG_ERROR, "trns before IHDR\n");
+                return AVERROR_INVALIDDATA;
+            } 
+
+            if (s->state & PNG_IDAT) {
+                av_log(avctx, AV_LOG_ERROR, "trns after IDAT\n");
+                return AVERROR_INVALIDDATA;
+            }
+
             /* read the transparency. XXX: Only palette mode supported */
             if (s->color_type != PNG_COLOR_TYPE_PALETTE ||
                 length > 256 ||
